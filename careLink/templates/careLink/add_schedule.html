{% extends 'careLink/base.html' %}
{% load widget_tweaks %}

{% block content %}
    <div class="container mt-4">
        {% if existing_schedules %}
        <h2>登録済みスケジュール</h2>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>タイトル</th>
                    <th>時間</th>
                    <th>繰り返し</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="schedule-list">
                {% for schedule in existing_schedules %}
                    <tr data-id = '{{ schedule.id }}'>
                        <td>{{ schedule.title }}</td>
                        <td>{{ schedule.time }}</td>
                        <td>{{ schedule.recurrence }}</td>
                        <td><button type="button" class="btn btn-danger delete-button" data-id="{{ schedule.id }}">削除</button></td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}



        <h2>新規追加 ({{ date }})</h2>
        <form method="post" class="mb-4" enctype="multipart/form-data">
            {% csrf_token %}
            {% comment %} effect画像を１日につき一つまでしか登録出来ないようにするとき {% endcomment %}
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %} 


            <div class="mb-3">
                {{ form.title.label_tag }} 
                {{ form.title|add_class:"form-control" }}
            </div>
            <div class="mb-3">
                {{ form.date.label_tag }} 
                {{ form.date|add_class:"form-control" }}
            </div>
            <div class="mb-3">
                {{ form.time.label_tag }} 
                {{ form.time|add_class:"form-control" }}
            </div>
            <div class="mb-3">
                {{ form.recurrence.label_tag }} 
                {{ form.recurrence|add_class:"form-control" }}
            </div>
            <div class="mb-3">
                {{ form.image.label_tag }}  <!-- 画像フィールドの追加 -->
                {{ form.image|add_class:"form-control" }}
                <p>＊日付につき一つまでしか画像は登録できません</p>
            </div>
            
            <div class="p-3">
                <button type="submit" class="btn btn-primary">登録</button>
                <a class="btn btn-outline-secondary" href="{% url 'careLink:calendar' %}">戻る</a>            
            </div>
            
        </form>
    </div>

<script>
    var el = document.getElementById('schedule-list');
    console.log(el)
    var sortable = Sortable.create(el, {
        onEnd: function (evt) {
            var order = [];
            for (var i = 0; i < el.children.length; i++) {
                order.push(el.children[i].getAttribute('data-id'));
            }
            console.log(order)
            // AJAXリクエストで行動順序を保存
            fetch('/careLink/save_order/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ order: order })
            });
        }
    });

    // 予定の削除を行う処理
    el.addEventListener('click', function(event) {
        if (event.target.classList.contains('delete-button')) {
            var scheduleId = event.target.dataset.id;
            if (confirm('本当に削除しますか？')) {
                fetch('/careLink/delete_schedule/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ schedule_id: scheduleId }) // schedule_idを送信
                }).then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        event.target.closest('tr').remove(); // 行を削除
                    } else {
                        alert('削除に失敗しました。');
                    }
                });
            }
        }
    });


    
</script>
{% endblock %}